var Se=Object.defineProperty,$e=Object.defineProperties;var Ue=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var Ee=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable;var te=(e,t,n)=>t in e?Se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,B=(e,t)=>{for(var n in t||(t={}))Ee.call(t,n)&&te(e,n,t[n]);if(ee)for(var n of ee(t))Pe.call(t,n)&&te(e,n,t[n]);return e},ne=(e,t)=>$e(e,Ue(t));var O=(e,t,n)=>new Promise((l,u)=>{var c=o=>{try{r(n.next(o))}catch(p){u(p)}},i=o=>{try{r(n.throw(o))}catch(p){u(p)}},r=o=>o.done?l(o.value):Promise.resolve(o.value).then(c,i);r((n=n.apply(e,t)).next())});import{_ as G,K as Re,a1 as Be,U as ke,w as Le,b as Me,I as Te,N as Fe}from"./index-795cdaa0.js";import{u as Ae,B as oe,b as se,a as le}from"./index-6ee1af83.js";import{c as _e}from"./index-22989de9.js";import{aK as Ie,aL as Ne,aM as De,aj as Oe,$ as z,n as N,N as ae,aN as ze,aJ as je,a9 as Ve,w as Ge,o as He}from"./elementui-66980f2a.js";import{f as $,u as C,E as D,ac as y,p as v,I as F,O as M,S as s,w as re,P,n as xe,r as _,X as qe,J as U,Q as V,t as I,G as X,q as k,Z as Ke,L,R as j}from"./vue-d691a816.js";import{d as We}from"./download-c98da083.js";import{d as Je}from"./index-51098d3a.js";var h=(e=>(e.SUCCESS="success",e.ERROR="error",e.UPLOADING="uploading",e))(h||{});const ue={api:{type:Function,default:null,required:!0},uploadName:{type:String,default:"file",required:!0},helpText:{type:String,default:""},maxSize:{type:Number,default:2},maxNumber:{type:Number,default:1/0},accept:{type:Array,default:()=>[]},multiple:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},uploadParams:{type:Object,default:{}}},ie={modelValue:{type:Array,default:()=>[]},showThumb:{type:Boolean,default:!1},thumbSize:{type:Number,default:200},showPreview:{type:Boolean,default:!0},showPreviewNumber:{type:Boolean,default:!0},emptyHidePreview:{type:Boolean,default:!1}},Qe=B(B({},ue),ie);function Xe(e,t){const n=t.join("|");return new RegExp(`\\.(${n})$`,"i").test(e.name)}function Ze(e){return pe(e.name)}function pe(e){return/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(e)}function Ye(e){return new Promise((t,n)=>{const l=new FileReader;l.readAsDataURL(e),l.onload=()=>t({result:l.result,file:e}),l.onerror=u=>n(u)})}function et({acceptRef:e,helpTextRef:t,maxNumberRef:n,maxSizeRef:l},u){const c=$(()=>{const o=C(e);return o&&o.length>0?o:[]}),i=$(()=>C(c).map(o=>o.indexOf("/")>0||o.startsWith(".")?o:`.${o}`).join(",")),r=$(()=>{const o=C(t);if(o)return o;const p=[],d=C(e);d.length>0&&p.push(`支持 ${d.join(",")} 格式`);const g=C(l);g&&p.push(`单个文件不超过 ${g} MB`);const S=C(n)-C(u).length;return S&&S!==1/0&&p.push(`最多只能上传 ${S} 个文件`),p.join("，")});return{getAccept:c,getStringAccept:i,getHelpText:r}}const tt=D({name:"UploadThumb",components:{ElImage:Ie},props:{url:String}});function nt(e,t,n,l,u,c){const i=y("ElImage");return e.url?(v(),F(i,{key:0,src:e.url,fit:"cover","preview-src-list":[e.url],style:{width:"100px",height:"100px"}},null,8,["src","preview-src-list"])):M("",!0)}const ce=G(tt,[["render",nt]]);function lt(){return[{prop:"thumbUrl",label:"略缩图",width:100,customRender:({record:e})=>{const{thumbUrl:t}=e||{};return t&&s(ce,{url:t},null)}},{prop:"name",label:"文件名",customRender:({text:e,record:t})=>{var i;const{percent:n,status:l}=t||{};let u,c=((i=t==null?void 0:t.responseData)==null?void 0:i.message)||null;if(l===h.ERROR){if(u="exception",c){const r=function(){return c}();c=s(De,{class:"mt-1",type:"error",truncated:!0},{default:()=>[s(Ne,{style:"width: 1em;height: 1em;vertical-align: middle;margin-right: 4px;display: inline-block;"},null),r]})}}else l===h.UPLOADING?u="":l===h.SUCCESS&&(u="success");return s("span",null,[s("p",{class:"truncate mb-1",title:e},[e]),s(Oe,{percentage:n,"text-inside":!0,"stroke-width":24,status:u},null),c])}},{prop:"size",label:"文件大小",width:100,customRender:({text:e=0})=>e&&`${(e/1024).toFixed(2)}KB`},{prop:"status",label:"状态",width:100,customRender:({text:e})=>e===h.SUCCESS?s(z,{type:"success"},{default:()=>"上传成功"}):e===h.ERROR?s(z,{type:"danger"},{default:()=>"上传失败"}):e===h.UPLOADING?s(z,null,{default:()=>"上传中"}):s(z,{type:"info"},{default:()=>"待上传"})}]}function ot(e){return{width:120,label:"操作",prop:"action",fixed:!1,customRender:({record:t})=>s(N,{type:"danger",onClick:e.bind(null,t)},{default:()=>"删除"})}}function st(){return[{prop:"url",label:"略缩图",width:100,customRender:({record:e})=>{const{url:t}=e||{};return pe(t)&&s(ce,{url:t},null)}},{prop:"name",label:"文件名"}]}function at({handleRemove:e,handleDownload:t}){return{width:200,label:"操作",prop:"action",fixed:!1,customRender:({record:n})=>s(ae,null,{default:()=>[s(N,{type:"danger",onClick:e.bind(null,n)},{default:()=>"删除"}),s(N,{type:"success",onClick:t.bind(null,n)},{default:()=>"下载"})]})}}const de=D({name:"FileList",props:{columns:{type:Array,default:null},actionColumn:{type:Object,default:null},dataSource:{type:Array,default:null}},setup(e){const t=Ae();return re(()=>e.dataSource,()=>{xe(()=>{var n;(n=t==null?void 0:t.redoModalHeight)==null||n.call(t)})}),()=>{const{columns:n,actionColumn:l,dataSource:u}=e,c=[...n,l];let i=null;return u!=null&&u.length?i=u.map((r={},o)=>s("tr",{key:`${o+r.name||""}`},[c.map(p=>{const{prop:d="",customRender:g,align:S="center"}=p;return s("td",{class:S,key:d},[typeof g=="function"?g==null?void 0:g({text:r[d],record:r}):r[d]])})])):i=s("tr",null,[s("td",{colspan:"5",style:"text-align: center;"},[P("无数据")])]),s("table",{class:"basic-upload-file-table"},[s("colgroup",null,[c.map(r=>{const{width:o=0,prop:p}=r,d={width:`${o}px`,minWidth:`${o}px`};return s("col",{style:o?d:{},key:p},null)})]),s("thead",null,[s("tr",null,[c.map(r=>{const{label:o="",align:p="center",prop:d}=r;return s("th",{class:p,key:d},[o])})])]),s("tbody",null,[i])])}}});const rt=D({components:{ElButton:N,ElUpload:ze,ElAlert:je,BasicModal:oe,FileList:de},props:ne(B({},ue),{prefixCls:String}),emits:["change","register","delete"],setup(e,{emit:t}){const n=_(!1),l=_([]),u=_([]),{accept:c,helpText:i,maxNumber:r,maxSize:o}=qe(e),[p,{closeModal:d}]=se(a=>{u.value=a||[]}),{getAccept:g,getStringAccept:S,getHelpText:E}=et({acceptRef:c,helpTextRef:i,maxNumberRef:r,maxSizeRef:o},u),{createMessage:R}=Re(),H=$(()=>l.value.length>0&&!l.value.every(a=>a.status===h.SUCCESS)),x=$(()=>{const a=l.value.some(m=>m.status===h.SUCCESS);return{btnText:"保存",type:"primary",disabled:n.value||l.value.length===0||!a}}),q=$(()=>({btnText:"关闭",disabled:n.value})),K=$(()=>n.value||l.value.length+u.value.length>=r.value),f=$(()=>{const a=l.value.some(m=>m.status===h.ERROR);return n.value?"上传中":a?"重新上传失败文件":"开始上传"});function A(){return l.value.length+u.value.length>r.value?(R.warning(`最多只能上传${r.value}个文件`),!1):!0}function fe(a){const m=C(g);return m.length>0&&!Xe(a,m)?(R.error(`只能上传${m.join(",")}格式文件`),!1):!0}function me(a=0){return o.value&&a/1024/1024>=o.value?(R.error(`只能上传不超过${o.value}MB的文件!`),!1):!0}function ge(a){const{size:m,name:b}=a;if(!A()||!me(a.size||0)||!fe(a))return;const w={uuid:Be(),file:a,size:m,name:b,percent:0,type:b.split(".").pop()};return Ze(a)?Ye(a).then(({result:W})=>{l.value=[...C(l),B({thumbUrl:W},w)]}):l.value=[...C(l),w],!1}function he(a){const m=l.value.findIndex(b=>b.uuid===a.uuid);m!==-1&&l.value.splice(m,1),t("delete",a)}function ye(a){return O(this,null,function*(){const{upload:m}=_e,{api:b,uploadName:w,uploadParams:W}=e;if(!b||typeof b!="function")return ke("upload api must exist and be a function");try{a.status=h.UPLOADING;const J=function(Y){const we=Y.loaded/Y.total*100|0;a.percent=we},Q=W||{};Q.file=a.file,Q[w]=a.file;const{data:T}=yield b(Q,J),Z=Ve(T,m.urlField);return Z?(a.status=h.SUCCESS,a.responseData=Z,{success:!0,error:null}):(a.status=h.ERROR,a.responseData=T,{success:!1,error:(T==null?void 0:T.message)||T})}catch(J){return a.status=h.ERROR,{success:!1,error:J}}})}function ve(){return O(this,null,function*(){if(A())try{n.value=!0;const a=l.value.filter(w=>w.status!==h.SUCCESS)||[],m=yield Promise.all(a.map(w=>ye(w)));n.value=!1;const b=m.filter(w=>!w.success);if(b.length>0)throw b}catch(a){throw n.value=!1,a}})}function Ce(){if(!A())return;if(n.value)return R.warning("请等待文件上传后，保存!");const a=[];for(const m of l.value){const{status:b,responseData:w}=m;b===h.SUCCESS&&typeof w=="string"&&a.push(w)}if(a.length<=0)return R.warning("没有上传成功的文件，无法保存!");l.value=[],d(),t("change",a)}function be(){return O(this,null,function*(){return n.value?(R.warning("请等待文件上传结束后操作"),!1):(l.value=[],!0)})}return{columns:lt(),actionColumn:ot(he),register:p,closeModal:d,getHelpText:E,getStringAccept:S,getConfirmProps:x,getCancelProps:q,beforeUpload:ge,getUploadState:K,fileListRef:l,isUploadingRef:n,handleStartUpload:ve,handleConfirm:Ce,handleCloseFn:be,getIsSelectFile:H,getUploadBtnText:f}}}),ut={style:{display:"flex","align-items":"center","margin-bottom":"8px"}};function it(e,t,n,l,u,c){const i=y("el-button"),r=y("ElAlert"),o=y("ElButton"),p=y("ElUpload"),d=y("FileList"),g=y("BasicModal");return v(),F(g,X({title:"上传"},e.$attrs,{"close-on-click-modal":!1,"close-on-press-escape":!1,class:"upload-modal",onRegister:e.register,onConfirm:e.handleConfirm,closeFn:e.handleCloseFn,"confirm-options":e.getConfirmProps,"cancel-options":e.getCancelProps}),{centerFooter:U(()=>[s(i,{onClick:e.handleStartUpload,type:"success",disabled:!e.getIsSelectFile,loading:e.isUploadingRef},{default:U(()=>[P(V(e.getUploadBtnText),1)]),_:1},8,["onClick","disabled","loading"])]),default:U(()=>[I("div",ut,[s(r,{style:{"--el-alert-padding":"8px 0"},title:e.getHelpText,type:"info",closable:!1},null,8,["title"]),s(p,{action:"emptyUrl",accept:e.getStringAccept,multiple:e.multiple,limit:e.maxNumber,disabled:e.getUploadState,"show-file-list":!1,"before-upload":e.beforeUpload,style:{"margin-left":"8px"}},{default:U(()=>[s(o,{type:"primary",disabled:e.getUploadState},{default:U(()=>[P("选择文件")]),_:1},8,["disabled"])]),_:1},8,["accept","multiple","limit","disabled","before-upload"])]),s(d,{dataSource:e.fileListRef,columns:e.columns,actionColumn:e.actionColumn},null,8,["dataSource","columns","actionColumn"])]),_:1},16,["onRegister","onConfirm","closeFn","confirm-options","cancel-options"])}const pt=G(rt,[["render",it]]),ct=D({components:{BasicModal:oe,FileList:de},props:{prefixCls:String},emits:["list-change","register","delete"],setup(e,{emit:t}){const n=_([]),[l,{closeModal:u}]=se(r=>{n.value=r.filter(o=>!!o).map(o=>({url:o,type:o.split(".").pop()||"",name:o.split("/").pop()||"-"}))});function c(r){const o=n.value.findIndex(p=>p.url===r.url);if(o!==-1){const p=n.value.splice(o,1);t("delete",p[0].url),t("list-change",n.value.map(d=>d.url))}}function i(r){const{url:o,name:p}=r;We(o,p)}return{register:l,closeModal:u,fileListRef:n,columns:st(),actionColumn:at({handleRemove:c,handleDownload:i})}}});function dt(e,t,n,l,u,c){const i=y("FileList"),r=y("BasicModal");return v(),F(r,X({title:"预览"},e.$attrs,{width:800,"close-on-click-modal":!1,"close-on-press-escape":!1,class:e.prefixCls,onRegister:e.register,showCancelBtn:!1,showConfirmBtn:!1}),{default:U(()=>[s(i,{dataSource:e.fileListRef,columns:e.columns,actionColumn:e.actionColumn},null,8,["dataSource","columns","actionColumn"])]),_:1},16,["class","onRegister"])}const ft=G(ct,[["render",dt]]),mt=D({name:"BasicUpload",components:{ElTooltip:Ge,ElButton:N,ElButtonGroup:ae,UploadModal:pt,UploadPreviewModal:ft,SvgIcon:Le},props:Qe,emits:["change","delete","preview-delete","update:modelValue"],setup(e,{emit:t,attrs:n}){const l=_([]),{prefixCls:u}=Me("basic-upload"),[c,{openModal:i}]=le(),[r,{openModal:o}]=le(),p=$(()=>{const{emptyHidePreview:f}=e;return f&&f?l.value.length>0:!0}),d=$(()=>{const{thumbSize:f}=e;return{["--thumb-size"]:`${f}px`}}),g=$(()=>B({},e)),S=$(()=>{const f=B(B({},n),C(g)),A=Object.keys(ie);return He(f,A)});function E(){i(!0,C(l))}function R(){o(!0,C(l))}function H(f){l.value=[...C(l),...f||[]],t("update:modelValue",l.value),t("change",l.value)}function x(f){l.value=[...f||[]],t("update:modelValue",l.value),t("change",l.value)}function q(f){t("delete",f)}function K(f){t("preview-delete",f)}return re(()=>e.modelValue,(f=[])=>{l.value=Array.isArray(f)?f:[]},{immediate:!0}),{prefixCls:u,fileList:l,showPreview:p,getProps:g,getBindValues:S,getThumbStyle:d,registerUploadModal:c,openUpload:E,handleChange:H,handlePreviewChange:x,registerPreviewModal:r,openPreview:R,handleDelete:q,handlePreviewDelete:K}}});const gt=["src","alt"],ht=I("span",null,"上传",-1);function yt(e,t,n,l,u,c){var S;const i=y("SvgIcon"),r=y("ElButton"),o=y("ElTooltip"),p=y("ElButtonGroup"),d=y("UploadModal"),g=y("UploadPreviewModal");return v(),k(j,null,[e.showThumb?(v(),k("div",{key:0,style:Ke(e.getThumbStyle),class:L(`${e.prefixCls}-entry-thumb`)},[(S=e.fileList)!=null&&S.length?(v(),k("div",{key:0,class:L(`${e.prefixCls}-entry-thumb__img`)},[I("img",{src:e.fileList[0],alt:e.fileList[0]},null,8,gt),I("div",{class:L(`${e.prefixCls}-entry-thumb__img-inner`)},[I("div",{class:L(`${e.prefixCls}-entry-thumb__img--upload`),onClick:t[0]||(t[0]=E=>e.openUpload())},[s(i,{name:"cloud-upload"}),P(" 上传 ")],2),e.getProps.showPreview?(v(),k("div",{key:0,class:L(`${e.prefixCls}-entry-thumb__img--preview`),onClick:t[1]||(t[1]=E=>e.openPreview())},[s(i,{name:"eye"}),P(" 预览 "),e.fileList.length&&e.showPreviewNumber?(v(),k(j,{key:0},[P("("+V(e.fileList.length)+")",1)],64)):M("",!0)],2)):M("",!0)],2)],2)):(v(),k("div",{key:1,class:L(`${e.prefixCls}-entry-thumb__btn`),onClick:t[2]||(t[2]=E=>e.openUpload())},[s(i,{name:"cloud-upload"})],2))],6)):(v(),F(p,{key:1,class:L(`${e.prefixCls}-entry-simple`)},{default:U(()=>[s(r,{type:"primary",onClick:t[3]||(t[3]=E=>e.openUpload())},{default:U(()=>[s(i,{name:"cloud-upload",class:"mr-1"}),ht]),_:1}),e.showPreview?(v(),F(o,{key:0,placement:"bottom"},{content:U(()=>[P(" 已上传 "),e.fileList.length?(v(),k(j,{key:0},[P(V(e.fileList.length),1)],64)):M("",!0)]),default:U(()=>[e.getProps.showPreview?(v(),F(r,{key:0,onClick:t[4]||(t[4]=E=>e.openPreview())},{default:U(()=>[s(i,{name:"eye"}),e.fileList.length&&e.showPreviewNumber?(v(),k(j,{key:0},[P(V(e.fileList.length),1)],64)):M("",!0)]),_:1})):M("",!0)]),_:1})):M("",!0)]),_:1},8,["class"])),s(d,X(e.getBindValues,{prefixCls:`${e.prefixCls}-upload-modal`,onRegister:e.registerUploadModal,onChange:e.handleChange,onDelete:e.handleDelete}),null,16,["prefixCls","onRegister","onChange","onDelete"]),s(g,{prefixCls:`${e.prefixCls}-preview-modal`,onRegister:e.registerPreviewModal,onListChange:e.handlePreviewChange,onDelete:e.handlePreviewDelete},null,8,["prefixCls","onRegister","onListChange","onDelete"])],64)}const vt=G(mt,[["render",yt]]),Bt=Te(vt),{uploadUrl:Ct=""}=Fe();function kt(e,t){return Je.uploadFile({url:Ct,onUploadProgress:t},e)}export{Bt as B,kt as u};
